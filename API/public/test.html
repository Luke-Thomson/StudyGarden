<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>API Tester · Generic Tools</title>
  <link rel="stylesheet" href="test-common.css" />
</head>
<body data-page="generic">
<header class="stack">
  <div class="row">
    <label class="card stack" style="flex:1 1 320px">
      <span class="small muted">API Base URL</span>
      <input id="baseUrl" placeholder="http://localhost:3333" />
    </label>
    <div class="card stack" style="flex:1 1 320px">
      <span class="small muted">Auth Token (Bearer)</span>
      <div class="row">
        <input id="token" placeholder="Will populate on login if response includes a token" style="flex:1" />
        <button id="clearToken" class="warn">Logout/clear</button>
      </div>
      <div class="small muted">
        Stored in <code class="badge">localStorage</code> as
        <code class="badge">api_token</code>.
      </div>
    </div>
    <div class="card stack" style="flex:0 0 220px; align-items:flex-start">
      <span class="small muted">Docs</span>
      <div class="row">
        <button id="openSwagger">/swagger</button>
        <button id="openDocs">/docs</button>
      </div>
    </div>
  </div>

  <nav class="nav-card">
    <a data-page-link="generic" href="test.html">Generic</a>
    <a data-page-link="auth" href="test-auth.html">Auth &amp; Profile</a>
    <a data-page-link="users" href="test-users.html">Users</a>
    <a data-page-link="subjects" href="test-subjects.html">Subjects</a>
    <a data-page-link="timer" href="test-timer.html">Timer</a>
    <a data-page-link="items" href="test-items.html">Items</a>
    <a data-page-link="inventory" href="test-inventory.html">Inventory</a>
    <a data-page-link="admin" href="test-admin.html">Admin</a>
  </nav>
</header>

<main class="stack" style="gap:16px;">
  <section class="grid">
    <div class="card stack">
      <h1>Generic Request Builder</h1>
      <p class="small muted">
        Use this page for ad-hoc calls. Authentication details and the base URL
        are shared across other tester pages via
        <code class="badge">localStorage</code>.
      </p>

      <div class="row">
        <select id="method">
          <option>GET</option>
          <option>POST</option>
          <option>PUT</option>
          <option>DELETE</option>
          <option>PATCH</option>
        </select>
        <input id="path" placeholder="/route (e.g. /users/1)" style="flex:1" />
        <button id="send">Send</button>
      </div>

      <textarea id="body" rows="6" placeholder="Optional JSON body"></textarea>

      <details>
        <summary>Headers (JSON) — optional</summary>
        <textarea id="headers" rows="4" placeholder='{"X-Example":"123"}'></textarea>
      </details>
    </div>

    <div class="card stack">
      <h2>Shortcuts</h2>
      <p class="small muted">
        Quickly hit frequently used routes without leaving this page.
      </p>
      <div class="row">
        <button id="btnPing">GET /</button>
        <button id="btnHealth">GET /health</button>
        <button id="btnSwagger">GET /swagger</button>
      </div>
    </div>
  </section>

  <section class="card stack">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div class="endpoint">
        <span class="method k" id="lastMethod"></span>
        <span id="lastUrl" class="muted" style="margin-left:6px"></span>
      </div>
      <div class="row small">
        <span id="statusBadge" class="pill">—</span>
      </div>
    </div>
    <div id="out">Response will appear here…</div>
  </section>
</main>

<script type="module">
  import { initLayout, request } from './test-common.js';

  initLayout();

  const sendBtn = document.getElementById('send');
  const methodEl = document.getElementById('method');
  const pathEl = document.getElementById('path');
  const bodyEl = document.getElementById('body');
  const headersEl = document.getElementById('headers');

  async function handleSend() {
    const method = methodEl.value.toUpperCase();
    const path = pathEl.value.trim() || '/';

    // Parse JSON body
    let body = null;
    const rawBody = bodyEl.value.trim();
    if (rawBody) {
      try {
        body = JSON.parse(rawBody);
      } catch {
        alert('Invalid JSON body');
        return;
      }
    }

    // Parse custom headers
    let headers = {};
    const rawHeaders = headersEl.value.trim();
    if (rawHeaders) {
      try {
        headers = JSON.parse(rawHeaders);
      } catch {
        alert('Invalid headers JSON');
        return;
      }
    }

    // Perform request
    await request(method, path, body, headers);
  }

  // Event listeners
  sendBtn.addEventListener('click', handleSend);
  document.getElementById('btnPing').addEventListener('click', () => request('GET', '/'));
  document.getElementById('btnHealth').addEventListener('click', () => request('GET', '/health'));
  document.getElementById('btnSwagger').addEventListener('click', () => request('GET', '/swagger'));
</script>
</body>
</html>

